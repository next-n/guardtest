// demo/upstream.ts
import http from "http";
var hits = 0;
var start = Date.now();
function modeNow() {
  const t = Date.now() - start;
  if (t < 4e3) return "slow-ok";
  if (t < 9e3) return "fail";
  return "recover";
}
var server = http.createServer((_, res) => {
  hits += 1;
  const mode = modeNow();
  console.log(`[upstream] hit #${hits} mode=${mode}`);
  if (mode === "fail") {
    setTimeout(() => {
      res.statusCode = 503;
      res.setHeader("content-type", "text/plain");
      res.end("upstream failing");
    }, 100);
    return;
  }
  const delay = mode === "slow-ok" ? 1500 : 200;
  setTimeout(() => {
    res.statusCode = 200;
    res.setHeader("content-type", "text/plain");
    res.end(`ok-${mode}-#${hits}`);
  }, delay);
});
server.listen(3001, () => {
  console.log("\u{1F6A7} upstream listening on http://localhost:3001");
  console.log("phases: 0-4s slow-ok | 4-9s fail(503) | 9s+ recover");
});
//# sourceMappingURL=upstream.js.map