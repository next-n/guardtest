"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));

// demo/upstream.ts
var import_node_http = __toESM(require("http"), 1);
var hits = 0;
var start = Date.now();
function modeNow() {
  const t = Date.now() - start;
  if (t < 4e3) return "slow-ok";
  if (t < 9e3) return "fail";
  return "recover";
}
var server = import_node_http.default.createServer((_, res) => {
  hits += 1;
  const mode = modeNow();
  console.log(`[upstream] hit #${hits} mode=${mode}`);
  if (mode === "fail") {
    setTimeout(() => {
      res.statusCode = 503;
      res.setHeader("content-type", "text/plain");
      res.end("upstream failing");
    }, 100);
    return;
  }
  const delay = mode === "slow-ok" ? 1500 : 200;
  setTimeout(() => {
    res.statusCode = 200;
    res.setHeader("content-type", "text/plain");
    res.end(`ok-${mode}-#${hits}`);
  }, delay);
});
server.listen(3001, () => {
  console.log("\u{1F6A7} upstream listening on http://localhost:3001");
  console.log("phases: 0-4s slow-ok | 4-9s fail(503) | 9s+ recover");
});
//# sourceMappingURL=upstream.cjs.map