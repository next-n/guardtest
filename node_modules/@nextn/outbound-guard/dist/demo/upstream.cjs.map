{"version":3,"sources":["../../demo/upstream.ts"],"sourcesContent":["// demo/upstream.ts\r\nimport http from \"node:http\";\r\n\r\nlet hits = 0;\r\nconst start = Date.now();\r\n\r\n/**\r\n * Deterministic phases (time-based):\r\n * 0s..4s    : slow OK (shows singleflight + microcache)\r\n * 4s..9s    : fail (503) (shows leader-only retry + breaker + shedding)\r\n * 9s..      : recover OK (shows recovery + fresh cache)\r\n */\r\nfunction modeNow(): \"slow-ok\" | \"fail\" | \"recover\" {\r\n  const t = Date.now() - start;\r\n  if (t < 4000) return \"slow-ok\";\r\n  if (t < 9000) return \"fail\";\r\n  return \"recover\";\r\n}\r\n\r\nconst server = http.createServer((_, res) => {\r\n  hits += 1;\r\n  const mode = modeNow();\r\n\r\n  console.log(`[upstream] hit #${hits} mode=${mode}`);\r\n\r\n  if (mode === \"fail\") {\r\n    // Return 503 quickly (retryable)\r\n    setTimeout(() => {\r\n      res.statusCode = 503;\r\n      res.setHeader(\"content-type\", \"text/plain\");\r\n      res.end(\"upstream failing\");\r\n    }, 100);\r\n    return;\r\n  }\r\n\r\n  const delay = mode === \"slow-ok\" ? 1500 : 200;\r\n\r\n  setTimeout(() => {\r\n    res.statusCode = 200;\r\n    res.setHeader(\"content-type\", \"text/plain\");\r\n    res.end(`ok-${mode}-#${hits}`);\r\n  }, delay);\r\n});\r\n\r\nserver.listen(3001, () => {\r\n  console.log(\"ðŸš§ upstream listening on http://localhost:3001\");\r\n  console.log(\"phases: 0-4s slow-ok | 4-9s fail(503) | 9s+ recover\");\r\n});\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AACA,uBAAiB;AAEjB,IAAI,OAAO;AACX,IAAM,QAAQ,KAAK,IAAI;AAQvB,SAAS,UAA0C;AACjD,QAAM,IAAI,KAAK,IAAI,IAAI;AACvB,MAAI,IAAI,IAAM,QAAO;AACrB,MAAI,IAAI,IAAM,QAAO;AACrB,SAAO;AACT;AAEA,IAAM,SAAS,iBAAAA,QAAK,aAAa,CAAC,GAAG,QAAQ;AAC3C,UAAQ;AACR,QAAM,OAAO,QAAQ;AAErB,UAAQ,IAAI,mBAAmB,IAAI,SAAS,IAAI,EAAE;AAElD,MAAI,SAAS,QAAQ;AAEnB,eAAW,MAAM;AACf,UAAI,aAAa;AACjB,UAAI,UAAU,gBAAgB,YAAY;AAC1C,UAAI,IAAI,kBAAkB;AAAA,IAC5B,GAAG,GAAG;AACN;AAAA,EACF;AAEA,QAAM,QAAQ,SAAS,YAAY,OAAO;AAE1C,aAAW,MAAM;AACf,QAAI,aAAa;AACjB,QAAI,UAAU,gBAAgB,YAAY;AAC1C,QAAI,IAAI,MAAM,IAAI,KAAK,IAAI,EAAE;AAAA,EAC/B,GAAG,KAAK;AACV,CAAC;AAED,OAAO,OAAO,MAAM,MAAM;AACxB,UAAQ,IAAI,uDAAgD;AAC5D,UAAQ,IAAI,qDAAqD;AACnE,CAAC;","names":["http"]}